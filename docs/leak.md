# Memory Leak

2022/3/20 左右出现了一个严重的memory leak问题，这里记录一下解决的过程和时间原因  

## 原因
之前写的时候没注意变量内存分配的问题，语句在哪我就在哪里插入分配变量的语句。
虽然我一度意识到了变量应该全部放在函数开头分配，而且我也看到了llvm的优化建议里
也有这一条，但是我当时忽视了它。  
结果就是这个造成了这次的memory leak：当你在循环中加alloca语句，每次循环都会新分配空间。
而老的空间直到函数退出才会被回收。而coroutine设计中每个线程都是死循环，会从队列中poll新的
job来做，这就导致首先该函数的栈会越来越大，其次因为函数不会执行完，对老的job的引用会一直停留在
函数栈上，导致gc永远回收不了。  

## Debug
虽然这个bug耗费了我巨大的力气来找，但是我学会了不少debug技巧：
- 查bdwgc的log
- 如果程序崩溃，把GC_malloc改成GC_malloc_uncollectable试试会不会继续crash，如果不会就代表存在误回收


